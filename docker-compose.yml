services:
  #######################################
  ############## Redis ##################
  #######################################
  redis:
    image: redis:7.2-alpine
    ports:
      - "6380:6379"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 30

  ######################################
  ############# FastAPI ################
  ######################################
  fastapi:
    build:
      context: .
      dockerfile: Dockerfile_app
      args:
        USER_UID: "${USER_UID:-1000}"
        USER_GID: "${USER_GID:-1000}"
    volumes:
      - "${HOST_DIR}:/data"
      - ./cp_server:/app/cp_server 
    environment:
      CELERY_BROKER_URL: "${CELERY_BROKER_URL}"
      CELERY_BACKEND_URL: "${CELERY_BACKEND_URL}"
      REDIS_HOST: "${REDIS_HOST:-redis}"
      REDIS_PORT: "${REDIS_PORT:-6379}"
      REDIS_DB: "${REDIS_DB:-2}"
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
      LOGFILE_NAME: "${LOGFILE_NAME:-task_servers.log}"
      SERVICE_NAME: fastapi
      RUNNING_AS_CELERY: "false"
    depends_on:
      - redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 3s
      retries: 30
    ports:
      - "8000:8000"

  #######################################
  ########### Celery Workers ############
  #######################################

  celery-default:
    build:
      context: .
      dockerfile: Dockerfile_celery_default
      args:
        USER_UID: "${USER_UID:-1000}"
        USER_GID: "${USER_GID:-1000}"
    volumes:
      - "${HOST_DIR}:/data"
      - ./cp_server:/app/cp_server 
    environment:
      CELERY_BROKER_URL: "${CELERY_BROKER_URL}"
      CELERY_BACKEND_URL: "${CELERY_BACKEND_URL}"
      REDIS_HOST: "${REDIS_HOST:-redis}"
      REDIS_PORT: "${REDIS_PORT:-6379}"
      REDIS_DB: "${REDIS_DB:-2}"
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
      LOGFILE_NAME: "${LOGFILE_NAME:-task_servers.log}"
      SERVICE_NAME: celery
      RUNNING_AS_CELERY: "true"
    depends_on:
      - redis
    restart: unless-stopped

  celery-gpu:
    build:
      context: .
      dockerfile: Dockerfile_celery
      args:
        USER_UID: "${USER_UID:-1000}"
        USER_GID: "${USER_GID:-1000}"
    volumes:
      - "${HOST_DIR}:/data"
      - ./cp_server:/app/cp_server
      - cellpose_models:/home/celeryuser/.cellpose
    environment:
      CELERY_BROKER_URL: "${CELERY_BROKER_URL}"
      CELERY_BACKEND_URL: "${CELERY_BACKEND_URL}"
      REDIS_HOST: "${REDIS_HOST:-redis}"
      REDIS_PORT: "${REDIS_PORT:-6379}"
      REDIS_DB: "${REDIS_DB:-2}"
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
      LOGFILE_NAME: "${LOGFILE_NAME:-task_servers.log}"
      SERVICE_NAME: celery
      RUNNING_AS_CELERY: "true"
    depends_on:
      - redis
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: "nvidia"
              count: all
              capabilities: ["gpu"]

volumes:
  cellpose_models:
