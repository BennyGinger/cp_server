version: '3.9'

# Define your anchor with all the shared bits
x-common_setup: &common_setup
  build:
    context: .
    dockerfile: Dockerfile_app
    args:
      USER_UID: "${USER_UID:-1000}"
      USER_GID: "${USER_GID:-1000}"
  volumes:
    - "${DATA_DIR}:/data"
    - ./cp_server:/app/cp_server
  environment:
    CELERY_BROKER_URL: "${CELERY_BROKER_URL}"
    CELERY_BACKEND_URL: "${CELERY_BACKEND_URL}"
  depends_on:
    - redis
  restart: on-failure

services:
#######################################
############## Redis ##################
#######################################
  redis:
    image: redis:latest
    ports:
      - "6380:6379"
    restart: on-failure

######################################
############# FastAPI ################
######################################
  fastapi:
    <<: *common_setup
    ports:
    - "8000:8000"
    environment:
      <<: *common_setup.environment
      SERVICE_NAME: fastapi
      
#######################################
########### Celery Workers ############
#######################################
  celery-default:
    <<: *common_setup
    build:
      dockerfile: Dockerfile_celery_default
    environment:
      <<: *common_setup.environment
      SERVICE_NAME: celery-default
  
  celery-gpu:
    <<: *common_setup
    build:
      dockerfile: Dockerfile_celery
    environment:
      <<: *common_setup.environment
      SERVICE_NAME: celery-gpu
    deploy:
      resources:
        reservations:
          devices:
            - driver: "nvidia"
              count: all
              capabilities: ["gpu"]
